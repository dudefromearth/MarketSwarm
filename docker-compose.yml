# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§­ MarketSwarm â€” Node-Native Architecture
# Author: Ernie Varitimos / FatTail Systems
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Version: v5.0 (Host-Network Edition)
#
# Core principle:
#   â€¢ All containers run in host network mode
#   â€¢ Redis buses (system, market, intel) live on the host:
#       system â†’ localhost:6379
#       market â†’ localhost:6380
#       intel  â†’ localhost:6381
#   â€¢ Containers use localhost directly â€” no DNS aliases or bridges
#   â€¢ Truth.json and environment are unified to reflect host-based Redis
#
# Benefits:
#   âœ… Zero network translation overhead
#   âœ… Containers share the same view of localhost as the host OS
#   âœ… Perfect semantic alignment with truth.json
#   âœ… Simpler orchestration via Whale + inject-truth
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

services:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1ï¸âƒ£ Data Tier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  rss_agg:
    image: marketswarm-rss_agg:latest
    build:
      context: .
      dockerfile: services/rss_agg/Dockerfile
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"
    network_mode: "host"
    environment:
      SERVICE_ID: "rss_agg"
      LOG_LEVEL: "INFO"
      SYSTEM_REDIS_URL: "redis://localhost:6379"
      MARKET_REDIS_URL: "redis://localhost:6380"
      INTEL_REDIS_URL:  "redis://localhost:6381"
      TRUTH_REDIS_KEY: "truth:doc"
      SCHEDULE_SEC: "600"
      FETCH_TIMEOUT_SEC: "8"
      MAX_PER_FEED: "50"
      USER_AGENT: "MarketSwarm/1.0 (+https://flyonthewall.ai/contact)"
      HEARTBEAT_CHANNEL: "heartbeat"
    command: ["python", "-u", "main.py"]
    volumes:
      - ./services/rss_agg:/app:delegated
      - ./shared:/app/shared:ro
      - ./feeds:/app/feeds
    restart: unless-stopped

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2ï¸âƒ£ Processing Tier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  vexy_ai:
    image: marketswarm-vexy_ai:latest
    build:
      context: services/vexy_ai
    network_mode: "host"
    command: ["python", "-u", "main.py"]
    environment:
      SERVICE_ID: "vexy_ai"
      LOG_LEVEL: "INFO"
      SYSTEM_REDIS_URL: "redis://localhost:6379"
      MARKET_REDIS_URL: "redis://localhost:6380"
      INTEL_REDIS_URL:  "redis://localhost:6381"
      HB_INTERVAL_SEC: "10"
    restart: unless-stopped

  massive:
    image: marketswarm-massive:latest
    build:
      context: services/massive
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"
    network_mode: "host"
    environment:
      SERVICE_ID: "massive"
      POLYGON_API_KEY: "${POLYGON_API_KEY}"
      MODE: "${MODE}"
      GROUP: "${GROUP}"
      LOG_LEVEL: "INFO"
      HB_INTERVAL_SEC: "5"
      HB_LABEL: "massive"
      HB_COUNT: "0"
      NET_PROBE_ON_START: "1"
      NET_TIMEOUT_SEC: "6"
      SYSTEM_REDIS_URL: "redis://localhost:6379"
      MARKET_REDIS_URL: "redis://localhost:6380"
      INTEL_REDIS_URL:  "redis://localhost:6381"
    volumes:
      - ${PWD}/logs/services/massive:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nprint('ok')\nPY"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  mesh:
    image: marketswarm-mesh:latest
    build: services/mesh
    network_mode: "host"
    environment:
      SERVICE_ID: "mesh"
      SYSTEM_REDIS_URL: "redis://localhost:6379"
      MARKET_REDIS_URL: "redis://localhost:6380"
      INTEL_REDIS_URL:  "redis://localhost:6381"
      TRUTH_FILE: ""  # Always pull from Redis
    restart: unless-stopped

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3ï¸âƒ£ Control Tier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  healer:
    image: marketswarm-healer:latest
    build:
      context: services/healer
    network_mode: "host"
    command: ["python", "-u", "monitor.py"]
    volumes:
      - ./services/healer:/app:ro
    environment:
      SERVICE_ID: "healer"
      LOG_LEVEL: "INFO"
      SYSTEM_REDIS_URL: "redis://localhost:6379"
      MARKET_REDIS_URL: "redis://localhost:6380"
      INTEL_REDIS_URL:  "redis://localhost:6381"
      TRUTH_REDIS_KEY: "truth:doc"
      REDIS_CONNECT_TIMEOUT: "15"
      DEFAULT_TIMEOUT_SEC: "60"
      ALERT_CHANNEL: "healer:alerts"
      HB_INTERVAL_SEC: "10"
    restart: unless-stopped

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4ï¸âƒ£ Optional Diagnostic Tier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  netcheck:
    image: curlimages/curl:8.11.1
    network_mode: "host"
    command:
      - sh
      - -c
      - |
        set -e
        echo "TCP egress:"; curl -fsS --connect-timeout 3 -o /dev/null http://1.1.1.1 && echo OK
        echo "DNS:"; nslookup example.com 1.1.1.1 >/dev/null && echo OK
        echo "HTTPS:"; curl -fsSIL --connect-timeout 3 --max-time 6 https://example.com | head -n1
        echo "RSS sample:"; curl -fsS --connect-timeout 6 --max-time 10 https://hnrss.org/frontpage | head -n3
        echo "netcheck: OK"
    profiles: ["diag"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§  Notes:
# â€¢ No external Docker networks are used.
# â€¢ Redis runs directly on the host (native).
# â€¢ Containers access Redis via localhost ports.
# â€¢ Truth.json should reflect "redis://localhost" URIs.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€