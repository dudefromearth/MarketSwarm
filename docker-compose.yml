version: "3.9"

services:
  # -------------------- Bootstrap (seed truth then exit) --------------------
  bootstrap:
    image: redis:7-alpine
    networks: [appnet]
    restart: "no"
    volumes:
      - ./truth.json:/seed/truth.json:ro
      - ./scripts/bootstrap.sh:/seed/bootstrap.sh:ro
      - ./scripts/lua_diff.lua:/seed/lua_diff.lua:ro
    environment:
      TRUTH_REDIS_URL: redis://host.docker.internal:6379
      MARKET_REDIS_URL: redis://host.docker.internal:6380
      RSS_REDIS_URL: redis://host.docker.internal:6381
    entrypoint: ["/bin/sh", "-eu", "/seed/bootstrap.sh"]

  # -------------------- RSS Aggregator --------------------
  rss_agg:
    image: marketswarm-rss_agg:latest
    build:
      context: .
      dockerfile: services/rss_agg/Dockerfile
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"
    environment:
      SERVICE_ID: "rss_agg"
      LOG_LEVEL: "INFO"
      REDIS_URL: "redis://host.docker.internal:6379"
      MARKET_REDIS_URL: "redis://host.docker.internal:6380"
      RSS_REDIS_URL: "redis://host.docker.internal:6381"
      TRUTH_REDIS_KEY: "truth:doc"
      SCHEDULE_SEC: "600"
      FETCH_TIMEOUT_SEC: "8"
      MAX_PER_FEED: "50"
      USER_AGENT: "MarketSwarm/1.0 (+https://flyonthewall.ai/contact)"
      HEARTBEAT_CHANNEL: "heartbeat"
    command: ["python", "main.py"]
    volumes:
      - ./services/rss_agg:/app:delegated
      - ./shared:/app/shared:ro
      - ./feeds:/app/feeds
    dns: ["8.8.8.8", "8.8.4.4"]
    restart: unless-stopped
    networks: [appnet]
    depends_on:
      bootstrap:
        condition: service_completed_successfully

  # -------------------- Vexy AI --------------------
  vexy_ai:
    image: marketswarm-vexy_ai:latest
    build:
      context: services/vexy_ai
    command: ["python", "-u", "main.py"]
    environment:
      SERVICE_ID: "vexy_ai"
      REDIS_URL: "redis://host.docker.internal:6379"
      MARKET_REDIS_URL: "redis://host.docker.internal:6380"
      RSS_REDIS_URL: "redis://host.docker.internal:6381"
      HB_INTERVAL_SEC: "10"
      LOG_LEVEL: "INFO"
    depends_on:
      bootstrap:
        condition: service_completed_successfully
    restart: unless-stopped
    networks: [appnet]

  # -------------------- Massive --------------------
  massive:
    image: marketswarm-massive:latest
    build:
      context: services/massive
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"
    environment:
      SERVICE_ID: "massive"
      POLYGON_API_KEY: "${POLYGON_API_KEY}"
      MODE: "${MODE}"
      GROUP: "${GROUP}"
      LOG_LEVEL: "INFO"
      HB_INTERVAL_SEC: "5"
      HB_LABEL: "massive"
      HB_COUNT: "0"
      NET_PROBE_ON_START: "1"
      NET_TIMEOUT_SEC: "6"
      SYSTEM_REDIS_URL: "redis://host.docker.internal:6379"
      MARKET_REDIS_URL: "redis://host.docker.internal:6380"
    volumes:
      - ${PWD}/logs/services/massive:/app/logs
    dns: ["8.8.8.8", "8.8.4.4"]
    depends_on:
      bootstrap:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nprint('ok')\nPY"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks: [appnet]

  # -------------------- Mesh Coordinator --------------------
  mesh:
    image: marketswarm-mesh:latest
    build: services/mesh
    environment:
      SERVICE_ID: "mesh"
      REDIS_URL: "redis://host.docker.internal:6379"
      TRUTH_FILE: ""  # Force Redis pull, no file fallback
    dns: ["8.8.8.8", "8.8.4.4"]
    depends_on:
      bootstrap:
        condition: service_completed_successfully
    restart: unless-stopped
    networks: [appnet]

  # -------------------- Healer --------------------
  healer:
    image: marketswarm-healer:latest
    build:
      context: services/healer
    command: ["python", "-u", "monitor.py"]
    volumes:
      - ./services/healer:/app:ro
    environment:
      SERVICE_ID: "healer"
      REDIS_URL: "redis://host.docker.internal:6379"
      TRUTH_REDIS_KEY: "truth:doc"
      REDIS_CONNECT_TIMEOUT: "15"
      DEFAULT_TIMEOUT_SEC: "60"
      ALERT_CHANNEL: "healer:alerts"
      HB_INTERVAL_SEC: "10"
      LOG_LEVEL: "INFO"
    depends_on:
      bootstrap:
        condition: service_completed_successfully
    restart: unless-stopped
    networks: [appnet]

  # -------------------- Sentinel --------------------
  sentinel:
    image: python:3.11-slim
    working_dir: /app
    command: ["python", "-u", "guard.py"]
    volumes:
      - ./services/sentinel:/app:ro
    environment:
      TRUTH_REDIS_URL: "redis://host.docker.internal:6379"
      TRUTH_REDIS_KEY: "truth:doc"
      SENTINEL_TIMEOUT_SEC: "30"
    depends_on:
      bootstrap:
        condition: service_completed_successfully
    restart: unless-stopped
    networks: [appnet]

  # -------------------- Network Diagnostics (Optional) --------------------
  netcheck:
    image: curlimages/curl:8.11.1
    network_mode: "service:rss_agg"
    command:
      - sh
      - -c
      - |
        set -e
        echo "TCP egress:"; curl -fsS --connect-timeout 3 -o /dev/null http://1.1.1.1 && echo OK
        echo "DNS:"; nslookup example.com 1.1.1.1 >/dev/null && echo OK
        echo "HTTPS:"; curl -fsSIL --connect-timeout 3 --max-time 6 https://example.com | head -n1
        echo "RSS sample:"; curl -fsS --connect-timeout 6 --max-time 10 https://hnrss.org/frontpage | head -n3
        echo "netcheck: OK"
    profiles: ["diag"]

networks:
  appnet:
    external: true
    name: marketswarm-bus