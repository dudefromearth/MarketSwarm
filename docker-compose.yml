# docker-compose.yml

services:
  # -------------------- Redis (primary) --------------------
  main-redis:
    image: redis:7-alpine
    command: [ "redis-server", "--appendonly", "yes" ]
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    ports:
      - "127.0.0.1:6379:6379"   # host-only bind for admin_console
    restart: unless-stopped

  # -------------------- Redis (market) --------------------
  market-redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # -------------------- RSS Aggregator --------------------
  rss_agg:
    dns: [ "8.8.8.8", "1.1.1.1" ]
    build:
      context: .                                # include shared/ in build
      dockerfile: services/rss_agg/Dockerfile
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"

    environment:
      # identity
      SERVICE_ID: "rss_agg"
      MODULE_NAME: "ingestor"
      LOG_LEVEL: "INFO"

      # ---- Logit mirroring â†’ Redis (ON) ----
      LOG_MIRROR_ENABLE: "1"
      LOG_REDIS_URL: "redis://main-redis:6379"
      LOG_KEY: "logs:rss_agg"          # list key to tail
      LOG_TTL_SEC: "86400"             # 24h retention
      LOG_LIST_MAX: "2000"             # keep last 2k lines
      # optional stream (disabled by default)
      # LOG_STREAM: "logs:stream:rss_agg"

      # ---- app config ----
      REDIS_URL: "redis://main-redis:6379"
      TRUTH_REDIS_KEY: "truth:doc"
      SCHEDULE_SEC: "600"
      FETCH_TIMEOUT_SEC: "8"
      MAX_PER_FEED: "50"
      USER_AGENT: "MarketSwarm/1.0 (+https://your.site/contact)"
      HEARTBEAT_CHANNEL: "heartbeat"

    depends_on:
      main-redis:
        condition: service_healthy
    restart: unless-stopped

    healthcheck:
      test: [ "CMD-SHELL", "python -c \"import importlib; importlib.import_module('ingestor'); print('ok')\"" ]
      interval: 30s
      timeout: 5s
      retries: 3

# -------------------- Vexu  AI --------------------
  vexy_ai:
    build:
      context: ./services/vexy_ai
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"
    environment:
      REDIS_URL: redis://main-redis:6379
      RSS_STREAM: rss:queue
      RSS_GROUP: vexy
      RSS_CONSUMER: vexy-1
      RSS_BLOCK_MS: "5000"
      LOG_LEVEL: "INFO"
    depends_on:
      main-redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "python - <<'PY'\nprint('ok')\nPY" ]
      interval: 30s
      timeout: 5s
      retries: 3

  # -------------------- Massive --------------------
  massive:
    build:
      context: services/massive
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"
    # no API key needed yet
    environment:
      LOG_LEVEL: "INFO"
      HB_INTERVAL_SEC: "5"
      HB_LABEL: "massive"
      HB_COUNT: "0"            # 0 = run forever
      NET_PROBE_ON_START: "1"  # run probe at container start
      NET_TIMEOUT_SEC: "6"
      # NET_HOST: "example.com"
      # NET_URL:  "https://example.com"
    volumes:
      - ./logs/services/massive:/app/logs
    dns: [ "8.8.8.8","8.8.4.4" ]   # optional; remove if your DNS is fine
    depends_on:
      main-redis:
        condition: service_healthy
      market-redis:
        condition: service_healthy
    restart: unless-stopped
    # minimal health (just that the process is alive). Upgrade later to hit Polygon.
    healthcheck:
      test: [ "CMD-SHELL", "python - <<'PY'\nprint('ok')\nPY" ]
      interval: 30s
      timeout: 5s
      retries: 3

  # -------------------- On-demand network diagnostics --------------------
  netcheck:
    image: curlimages/curl:8.11.1
    network_mode: "service:ingestor"
    command:
      - sh
      - -c
      - |
        set -e
        echo "TCP egress:"; curl -fsS --connect-timeout 3 -o /dev/null http://1.1.1.1 && echo OK
        echo "DNS:"; nslookup example.com 1.1.1.1 >/dev/null && echo OK
        echo "HTTPS:"; curl -fsSIL --connect-timeout 3 --max-time 6 https://example.com | head -n1
        echo "RSS sample:"; curl -fsS --connect-timeout 6 --max-time 10 https://hnrss.org/frontpage | head -n3
        echo "netcheck: OK"
    profiles: ["diag"]

  # -------------------- Mesh Coordinator --------------------
  mesh_coordinator:
    build: ./services/mesh_coordinator
    image: mesh-coordinator
    environment:
      SERVICE_ID: "mesh_coordinator"
      REDIS_MAIN_URL: "redis://main-redis:6379"
    depends_on:
      main-redis:
        condition: service_healthy
    restart: unless-stopped

  # -------------------- Log Analyzer --------------------
  logger:
    build:
      context: ./services/logger
    environment:
      SERVICE_ID: "logger"
      REDIS_MAIN_URL: "redis://main-redis:6379"
      HEARTBEAT_CHANNEL: "heartbeats"
      HEARTBEAT_INTERVAL: "10"
    depends_on:
      main-redis:
        condition: service_healthy
    restart: unless-stopped

  play-redis:
    image: redis:7-alpine
    command: [ "redis-server", "--appendonly", "yes" ]
    ports:
      - "127.0.0.1:6400:6379"   # host-only exposure on 6400
    volumes:
      - play-redis-data:/data   # persistent (see ephemeral option below)
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    profiles: [ "play" ]          # only runs when you ask for the 'play' profile

  # (at the bottom of the compose file, if not already present)
  volumes:
  play-redis-data: {}