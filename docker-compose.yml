# docker-compose.yml

services:
 # -------------------- One Shoot Bootstrap --------------------
  truth_sync:
    image: python:3.12-slim
    working_dir: /app
    env_file: .env
    volumes:
      - .:/app:ro
      - ${TRUTH_FILE}:/app/truth.json:ro
      - ${TRUTH_SECRETS_FILE}:/app/truth_secrets.json:ro
    command:
      - python
      - -u
      - load_truth.py
      - --redis-url
      - ${BOOTSTRAP_REDIS_URL}
      - --truth
      - /app/truth.json
      - --secrets
      - /app/truth_secrets.json
    depends_on:
      main-redis:
        condition: service_healthy
    restart: "no"

  # -------------------- Redis (primary) --------------------
  main-redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # -------------------- Redis (market) --------------------
  market-redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # -------------------- RSS Aggregator --------------------
  rss_agg:
    build:
      context: ./services/rss_agg
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"
    environment:
      REDIS_URL: redis://main-redis:6379
      FEEDS_FILE: /app/config/feeds.txt
      SCHEDULE_SEC: "600"
      FETCH_TIMEOUT_SEC: "8"
      MAX_PER_FEED: "50"
      USER_AGENT: "MarketSwarm/1.0 (+https://your.site/contact)"
      LOG_LEVEL: "INFO"
    volumes:
      - ./services/ingestor/config:/app/config:ro
    depends_on:
      main-redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "python - <<'PY'\nprint('ok')\nPY" ]
      interval: 30s
      timeout: 5s
      retries: 3

# -------------------- Vexu  AI --------------------
  vexy_ai:
    build:
      context: ./services/vexy_ai
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"
    environment:
      REDIS_URL: redis://main-redis:6379
      RSS_STREAM: rss:queue
      RSS_GROUP: vexy
      RSS_CONSUMER: vexy-1
      RSS_BLOCK_MS: "5000"
      LOG_LEVEL: "INFO"
    depends_on:
      main-redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "python - <<'PY'\nprint('ok')\nPY" ]
      interval: 30s
      timeout: 5s
      retries: 3

  # -------------------- Polygon WS --------------------
  massive:
    build:
      context: services/massive
      args:
        UID: "${UID:-10001}"
        GID: "${GID:-10001}"
    # no API key needed yet
    environment:
      LOG_LEVEL: "INFO"
      HB_INTERVAL_SEC: "5"
      HB_LABEL: "massive"
      HB_COUNT: "0"            # 0 = run forever
      NET_PROBE_ON_START: "1"  # run probe at container start
      NET_TIMEOUT_SEC: "6"
      # NET_HOST: "example.com"
      # NET_URL:  "https://example.com"
    volumes:
      - ./logs/services/massive:/app/logs
    dns: [ "8.8.8.8","8.8.4.4" ]   # optional; remove if your DNS is fine
    depends_on:
      main-redis:
        condition: service_healthy
      market-redis:
        condition: service_healthy
    restart: unless-stopped
    # minimal health (just that the process is alive). Upgrade later to hit Polygon.
    healthcheck:
      test: [ "CMD-SHELL", "python - <<'PY'\nprint('ok')\nPY" ]
      interval: 30s
      timeout: 5s
      retries: 3

  # -------------------- On-demand network diagnostics --------------------
  netcheck:
    image: curlimages/curl:8.11.1
    network_mode: "service:ingestor"
    command:
      - sh
      - -c
      - |
        set -e
        echo "TCP egress:"; curl -fsS --connect-timeout 3 -o /dev/null http://1.1.1.1 && echo OK
        echo "DNS:"; nslookup example.com 1.1.1.1 >/dev/null && echo OK
        echo "HTTPS:"; curl -fsSIL --connect-timeout 3 --max-time 6 https://example.com | head -n1
        echo "RSS sample:"; curl -fsS --connect-timeout 6 --max-time 10 https://hnrss.org/frontpage | head -n3
        echo "netcheck: OK"
    profiles: ["diag"]