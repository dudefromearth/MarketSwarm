<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MarketSwarm Admin</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [switches, setSwitches] = useState({});
      const [articles, setArticles] = useState([]);
      const [selected, setSelected] = useState(null);

      const refresh = () => {
        fetch("/api/status").then(r => r.json()).then(setSwitches);
        fetch("/api/articles").then(r => r.json()).then(setArticles);
      };

      useEffect(() => {
        refresh();
        const es = new EventSource("/stream");
        es.onmessage = () => refresh();
        return () => es.close();
      }, []);

      const toggle = (stage) => {
        const newVal = switches[stage] ? 0 : 1;
        fetch(`/api/toggle/${stage}/${newVal}`);
      };

      return (
        <div class="p-8 max-w-6xl mx-auto">
          <h1 class="text-4xl mb-8">MarketSwarm Admin</h1>

          <div class="grid grid-cols-2 gap-8">
            <div class="bg-gray-800 p-6 rounded">
              <h2 class="text-2xl mb-4">Pipeline Control</h2>
              {Object.entries(switches).map(([k, v]) => (
                <div key={k} class="flex justify-between items-center py-2">
                  <span class="capitalize">{k}</span>
                  <button onClick={() => toggle(k)}
                    class={`px-4 py-2 rounded ${v ? "bg-green-600" : "bg-red-600"}`}>
                    {v ? "ON" : "OFF"}
                  </button>
                </div>
              ))}
            </div>

            <div class="bg-gray-800 p-6 rounded">
              <h2 class="text-2xl mb-4">Recent Articles</h2>
              {articles.map(a => (
                <div key={a.uid} class="py-2 border-b border-gray-700 cursor-pointer hover:bg-gray-700"
                     onClick={() => setSelected(a.uid)}>
                  <div class="font-bold">{a.title}</div>
                  <div class="text-sm text-gray-400">
                    {a.source === "llm-success" ? "AI" : "STATIC"} â€¢ {a.uid}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {selected && <div class="mt-8 bg-gray-800 p-6 rounded">Loading article {selected}...</div>}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>