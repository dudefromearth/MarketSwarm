#!/bin/bash
set -euo pipefail

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ§¬  MarketSwarm Node Spawner â€” Birth of a Sovereign
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BOLD=$(tput bold)
RESET=$(tput sgr0)
BLUE='\033[1;34m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
CYAN='\033[1;36m'
RED='\033[1;31m'

# --- Defaults ---
NODE_NAME=""
NODE_VERSION=""
NODE_PURPOSE=""
ARCHIVE_DIR="spawn"
COMPOSE_FILE="docker-compose.yml"

# --- Helper: Prompt with contemplation pause ---
ask() {
  local prompt="$1"
  local default="${2:-}"
  local input
  echo -ne "${CYAN}${prompt}${RESET}"
  [ -n "$default" ] && echo -ne " [${YELLOW}${default}${RESET}]"
  echo -n ": "
  read -r input
  echo ""
  if [ -z "$input" ] && [ -n "$default" ]; then
    echo "$default"
  else
    echo "$input"
  fi
}

# --- Help ---
show_help() {
  echo -e "${BOLD}ğŸ§¬  MarketSwarm Node Spawner â€” Birth of a Sovereign${RESET}"
  echo ""
  echo -e "${CYAN}Usage:${RESET}  ./spawn [options]"
  echo ""
  echo -e "${CYAN}Options:${RESET}"
  echo -e "  ${YELLOW}--name <name>${RESET}       Name of this sovereign node"
  echo -e "  ${YELLOW}--version <ver>${RESET}     Version tag (e.g., v1.0.0)"
  echo -e "  ${YELLOW}--purpose <text>${RESET}    Brief description of its role"
  echo -e "  ${YELLOW}-h, --help${RESET}          Show this message"
  echo ""
  echo -e "${CYAN}Example:${RESET}"
  echo -e "  ./spawn --name VEXY-ALPHA --version v1.0.0 --purpose \"RSS Aggregator + Publisher\""
  echo ""
  exit 0
}

# --- Parse arguments ---
while [[ $# -gt 0 ]]; do
  case "$1" in
    --name) NODE_NAME="$2"; shift 2 ;;
    --version) NODE_VERSION="$2"; shift 2 ;;
    --purpose) NODE_PURPOSE="$2"; shift 2 ;;
    -h|--help) show_help ;;
    *) echo "Unknown option: $1"; exit 1 ;;
  esac
done

# --- Wizard prompts if missing ---
[ -z "$NODE_NAME" ] && NODE_NAME=$(ask "Enter node name" "VEXY-NODE")
[ -z "$NODE_VERSION" ] && NODE_VERSION=$(ask "Enter version tag" "v1.0.0")
[ -z "$NODE_PURPOSE" ] && NODE_PURPOSE=$(ask "Describe this nodeâ€™s purpose" "General Aggregator")

# --- Ritual banner ---
clear
echo -e "${BLUE}ğŸ£  Initiating Spawn Ritual â€” Forging Sovereign ${NODE_NAME} (${NODE_VERSION})${RESET}"
echo -e "${CYAN}Purpose:${RESET} ${NODE_PURPOSE}"
echo ""
sleep 2

# --- Step 1: Stop active containers ---
echo -e "${YELLOW}ğŸ§¹  Shutting down active containers...${RESET}"
docker compose -f "$COMPOSE_FILE" down -v --remove-orphans || true

# --- Step 2: Purge residuals ---
echo -e "${YELLOW}ğŸ§½  Cleaning old images, volumes, and networks...${RESET}"
docker system prune -af --volumes || true

# --- Step 3: Rebuild everything from source ---
echo -e "${YELLOW}ğŸ—ï¸  Rebuilding full stack from clean context...${RESET}"
docker compose -f "$COMPOSE_FILE" build --no-cache

# --- Step 4: Bring up core services only for verification ---
echo -e "${CYAN}ğŸš€  Launching verification stack...${RESET}"
docker compose -f "$COMPOSE_FILE" up -d system-redis market-redis bootstrap
echo -e "â³  Waiting for Redis to report healthy..."
sleep 5
until [[ $(docker inspect --format='{{.State.Health.Status}}' system-redis 2>/dev/null) == "healthy" && \
        $(docker inspect --format='{{.State.Health.Status}}' market-redis 2>/dev/null) == "healthy" ]]; do
  echo "  â†’ Still warming up..."
  sleep 2
done
echo -e "${GREEN}âœ…  Redis verified healthy.${RESET}"

# --- Step 5: Verify truth:doc existence ---
if docker exec system-redis redis-cli EXISTS truth:doc | grep -q 1; then
  echo -e "${GREEN}âœ…  truth:doc verified in system-redis.${RESET}"
else
  echo -e "${RED}âŒ  truth:doc missing â€” bootstrap may have failed.${RESET}"
  exit 2
fi

# --- Step 6: Tag images ---
echo -e "${YELLOW}ğŸ·ï¸  Tagging images for archival...${RESET}"
TAG_BASE="marketswarm-${NODE_NAME,,}-${NODE_VERSION}"
for svc in $(docker compose config --services); do
  img=$(docker compose config | grep "image:" | awk '{print $2}' | head -n 1)
  docker tag "$svc" "${TAG_BASE}-${svc}:latest" 2>/dev/null || true
done

# --- Step 7: Create archive directory ---
mkdir -p "$ARCHIVE_DIR"

# --- Step 8: Save images to tar archive ---
ARCHIVE_FILE="${ARCHIVE_DIR}/${NODE_NAME}-${NODE_VERSION}.tar"
echo -e "${CYAN}ğŸ“¦  Saving full image set to ${ARCHIVE_FILE}...${RESET}"
docker save -o "$ARCHIVE_FILE" $(docker compose config | grep 'image:' | awk '{print $2}' | sort -u)

# --- Step 9: Write genesis metadata ---
GENESIS_FILE="${ARCHIVE_DIR}/${NODE_NAME}-${NODE_VERSION}-genesis.json"
cat > "$GENESIS_FILE" <<EOF
{
  "node_name": "${NODE_NAME}",
  "version": "${NODE_VERSION}",
  "purpose": "${NODE_PURPOSE}",
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "docker_compose": "${COMPOSE_FILE}",
  "images_archived": true
}
EOF
echo -e "${GREEN}âœ…  Genesis file written: ${GENESIS_FILE}${RESET}"

# --- Step 10: Shutdown verification stack ---
echo -e "${YELLOW}ğŸ§˜  Shutting down verification stack...${RESET}"
docker compose down -v --remove-orphans || true

# --- Step 11: Completion banner ---
echo ""
echo -e "${GREEN}ğŸ‰  Spawn complete â€” Sovereign ${NODE_NAME} v${NODE_VERSION} is ready!${RESET}"
echo -e "${CYAN}Artifacts:${RESET}"
echo -e "  â€¢ ${ARCHIVE_FILE}"
echo -e "  â€¢ ${GENESIS_FILE}"
echo ""
echo -e "${YELLOW}ğŸ’¡  To deploy on a new host:${RESET}"
echo -e "  scp ${ARCHIVE_FILE} user@target:/srv/"
echo -e "  ssh user@target 'docker load -i /srv/$(basename $ARCHIVE_FILE)'"
echo -e "  ssh user@target 'docker compose up -d'"
echo ""
echo -e "${BLUE}ğŸ•Šï¸  Go forth, ${NODE_NAME} â€” your universe awaits.${RESET}"